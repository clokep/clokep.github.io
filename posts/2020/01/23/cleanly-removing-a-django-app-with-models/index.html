<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Feed configuration. -->
    <link href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Patrick Cloke Atom Feed" />
    <link href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Patrick Cloke RSS Feed" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="/theme/css/styles.css">
    <link rel="stylesheet" href="/theme/css/borland.css">
    <link rel="stylesheet" href="/theme/css/youtube.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <title>Cleanly removing a Django app (with models)</title>

    <meta property="og:site_name" content="Patrick Cloke" />
<meta property="og:title" content="Cleanly removing a Django app (with models)" />
<meta property="og:url" content="https://patrick.cloke.us/posts/2020/01/23/cleanly-removing-a-django-app-with-models/" />
<meta property="og:description" content="While pruning features from our product it was necessary to fully remove some Django apps that had models in them. If the code is just removed than the tables (and some other references) will be left in the database. After doing this a few times for work I came up …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-23T21:57:00-05:00" />
<meta property="article:author" content="Patrick Cloke" />
<meta property="article:tag" content="django" />

    <script async defer data-domain="cloke.us" src="https://plausible.io/js/plausible.js"></script>
  </head>

  <body class="pb-5">
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light border-bottom border-info">
      <a class="navbar-brand" href="/">
        Patrick Cloke
      </a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbar-items">
        <ul class="navbar-nav ml-auto">

          <li class="nav-item">
            <a class="nav-link" href="/pages/about.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/pages/projects.html">Projects</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/archives.html">Archives</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tags.html">Tags</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="social-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Social
            </a>

            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="social-dropdown">
              <a class="dropdown-item" href="https://www.twitter.com/clokep" target="_blank">
                <span class="fab fa-twitter mr-1"></span> twitter
              </a>
              <a class="dropdown-item" href="https://mastodon.social/@clokep" target="_blank">
                <span class="fab fa-mastodon mr-1"></span> mastodon
              </a>
              <a class="dropdown-item" href="https://www.github.com/clokep" target="_blank">
                <span class="fab fa-github mr-1"></span> github
              </a>
              <a class="dropdown-item" href="https://gitlab.com/clokep" target="_blank">
                <span class="fab fa-gitlab mr-1"></span> gitlab
              </a>
              <a class="dropdown-item" href="https://bitbucket.org/clokep" target="_blank">
                <span class="fab fa-bitbucket mr-1"></span> bitbucket
              </a>
              <a class="dropdown-item" href="https://mozillians.org/u/clokep/" target="_blank">
                <span class="fab fa-firefox mr-1"></span> mozillians
              </a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="feeds-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Feeds
            </a>

            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="feeds-dropdown">
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a>
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a>
            </div>
          </li>

          <form class="form-inline" method="get" action="http://www.google.com/search">
            <input class="form-control form-control-sm mr-sm-2" type="search" name="q" placeholder="Search" aria-label="Search" />
            <input type="hidden"  name="sitesearch" value="patrick.cloke.us" />

            <button class="btn btn-sm btn-outline-info d-none d-sm-inline" type="submit">Search</button>
          </form>
        </ul>
      </div>
    </nav>

<div class="container">
  <div class="row">
    <div class="col-md-12 mt-2 mb-2">
      <h1>
        <a href="/posts/2020/01/23/cleanly-removing-a-django-app-with-models/" rel="bookmark"
           title="Permalink to Cleanly removing a Django app (with models)">Cleanly removing a Django app (with&nbsp;models)</a>
      </h1>

      <div class="float-right">
        <a href="https://twitter.com/intent/tweet?text=Cleanly%20removing%20a%20Django%20app%20%28with%C2%A0models%29&url=https%3A//patrick.cloke.us/posts/2020/01/23/cleanly-removing-a-django-app-with-models/&hashtags=django" target="_blank" class="ml-1 mr-1" title="Share on Twitter">
          <span class="fab fa-twitter"></span>
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//patrick.cloke.us/posts/2020/01/23/cleanly-removing-a-django-app-with-models/" target="_blank" class="ml-1 mr-1" title="Share on Facebook">
          <span class="fab fa-facebook"></span>
        </a>
        <a href="mailto:?subject=Cleanly%20removing%20a%20Django%20app%20%28with%C2%A0models%29&amp;body=https%3A//patrick.cloke.us/posts/2020/01/23/cleanly-removing-a-django-app-with-models/" target="_blank" class="ml-1 mr-1" title="Share via Email">
          <span class="fas fa-envelope"></span>
        </a>
      </div>

      <i>Thursday, January 23, 2020</i>

      <br>
      <i>
        Tags:           <a href="/tag/django.html">django</a>      </i>

      <div class="mt-3">

        <p>While pruning features from our product it was necessary to fully remove some
Django apps that had models in them. If the code is just removed than the tables
(and some other references) will be left in the&nbsp;database.</p>
<p>After doing this a few times for work I came up with the following basic steps
to completely remove a Django&nbsp;app.</p>
<ol class="arabic simple">
<li>Remove any references to the app outside of itself (e.g. <tt class="docutils literal">grep</tt> for the
model names and other&nbsp;imports).</li>
<li>Remove the any other files: e.g. <tt class="docutils literal">forms.py</tt>, <tt class="docutils literal">urls.py</tt>, <tt class="docutils literal">views.py</tt>,
etc. Be sure to leave the migrations&nbsp;alone.</li>
<li>Remove all content from the <tt class="docutils literal">models.py</tt> file (but leave the file&nbsp;itself).</li>
<li>Deploy to ensure nothing is attempting to access the model&#8217;s&nbsp;tables.</li>
<li>Run <tt class="docutils literal">python manage.py makemigrations</tt> to generate the migrations that will
delete the database&nbsp;tables.</li>
<li>Deploy <span class="amp">&amp;</span> run the&nbsp;migrations.</li>
<li>Delete the app&nbsp;completely.</li>
<li>Remove references to the app in <tt class="docutils literal">INSTALLED_APPS</tt>.</li>
<li>Deploy so that nothing is referencing the&nbsp;app.</li>
<li>Run the following <span class="caps">SQL</span> commands to remove other references to the app in the
database (replace <tt class="docutils literal">my_app</tt> with the name of the app being&nbsp;removed):</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">Remove</span> <span class="n">Django</span> <span class="n">migrations</span><span class="p">.</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">django_migrations</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">app</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;my_app&#39;</span><span class="p">;</span>
<span class="o">#</span> <span class="k">Get</span> <span class="n">rid</span> <span class="k">of</span> <span class="n">permissions</span> <span class="k">and</span> <span class="n">content</span> <span class="n">types</span><span class="p">.</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">auth_permission</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">content_type_id</span><span class="o">`</span> <span class="k">in</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">django_content_type</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">app_label</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;my_app&#39;</span><span class="p">);</span>
<span class="o">#</span> <span class="k">Get</span> <span class="n">rid</span> <span class="k">of</span> <span class="k">admin</span> <span class="n">changes</span><span class="p">.</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">django_admin_log</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">content_type_id</span><span class="o">`</span> <span class="k">in</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">django_content_type</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">app_label</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;my_app&#39;</span><span class="p">);</span>
<span class="o">#</span> <span class="n">Finally</span><span class="p">,</span> <span class="k">delete</span> <span class="n">the</span> <span class="n">content</span> <span class="k">type</span><span class="p">.</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">`</span><span class="n">django_content_type</span><span class="o">`</span> <span class="k">WHERE</span> <span class="o">`</span><span class="n">app_label</span><span class="o">`</span> <span class="o">=</span> <span class="s1">&#39;my_app&#39;</span><span class="p">;</span>
</pre></div>
<p>If you&#8217;re in the unfortunate situation of removing a third-party application
that has models, I&#8217;ve found it easiest to replace steps 2 - 3 <span class="amp">&amp;</span> 5 - 6 with
standard drop table&nbsp;calls:</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">my_app_some_model</span><span class="o">`</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">my_app_other_model</span><span class="o">`</span><span class="p">;</span>
</pre></div>
<p>I&#8217;m fairly certain I got the initial idea for this from somewhere else, but
unfortunately I didn&#8217;t save the original source. It has evolved over the past
years to be easier to run (e.g. the sub-queries) and I have used it &gt; 5 times
without issues. It probably should be abstracted into a management command, but
I never got around to&nbsp;it.</p>
<p>I&#8217;m still surprised there isn&#8217;t (to my knowledge) an easier way to do this
within&nbsp;Django!</p>

      </div>

<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = '/posts/2020/01/23/cleanly-removing-a-django-app-with-models/';
this.page.identifier = 'cleanly-removing-a-django-app-with-models';
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://clokep.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </div>
</div>

    <nav class="navbar fixed-bottom navbar-light bg-light border-top border-info">
      <a href="https://getpelican.com/" class="nav-item" target="_blank">Powered by Pelican</a>
      <a href="https://github.com/clokep/clokep.github.io" class="nav-item" target="_blank">
        Source available on GitHub <span class="fab fa-github"></span>
      </a>
    </nav>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  </body>
</html>