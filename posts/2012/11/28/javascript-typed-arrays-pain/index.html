<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Feed configuration. -->
    <link href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Patrick Cloke Atom Feed" />
    <link href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Patrick Cloke RSS Feed" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="/theme/css/styles.css">
    <link rel="stylesheet" href="/theme/css/borland.css">
    <link rel="stylesheet" href="/theme/css/youtube.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <title>JavaScript typed arrays pain</title>

    <meta property="og:site_name" content="Patrick Cloke" />
<meta property="og:title" content="JavaScript typed arrays pain" />
<meta property="og:url" content="https://patrick.cloke.us/posts/2012/11/28/javascript-typed-arrays-pain/" />
<meta property="og:description" content="If you’ve ever tried to deal with binary data in JavaScript you know it isn’t much fun and you usually resort to using strings lots of charCodeAt and related functions. Typed arrays are supposed to solve this though! The typed array API consists of creating a buffer of …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-11-28T23:11:00-05:00" />
<meta property="article:author" content="Patrick Cloke" />
<meta property="article:tag" content="Instantbird" />
<meta property="article:tag" content="Mozilla" />
<meta property="article:tag" content="OSCAR" />
<meta property="article:tag" content="Thunderbird" />
<meta property="article:tag" content="Wat" />

    <script async defer data-domain="cloke.us" src="https://plausible.io/js/plausible.js"></script>
  </head>

  <body class="pb-5">
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light border-bottom border-info">
      <a class="navbar-brand" href="/">
        Patrick Cloke
      </a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <span class="collapse navbar-collapse" id="navbar-items">
        <ul class="navbar-nav ml-auto">

          <li class="nav-item">
            <a class="nav-link" href="/pages/about.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/pages/projects.html">Projects</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/archives.html">Archives</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tags.html">Tags</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="social-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Social
            </a>

            <span class="dropdown-menu dropdown-menu-right" aria-labelledby="social-dropdown">
              <a class="dropdown-item" href="https://mastodon.social/@clokep" target="_blank">
                  <span class="fab fa-mastodon mr-1"></span>
                mastodon
              </a>
              <a class="dropdown-item" href="https://www.twitter.com/clokep" target="_blank">
                  <span class="fab fa-twitter mr-1"></span>
                twitter
              </a>
              <a class="dropdown-item" href="https://matrix.to/#/@clokep:matrix.org" target="_blank">
                  <span class="pl-3 mr-2"></span>
                matrix
              </a>
              <a class="dropdown-item" href="https://github.com/clokep" target="_blank">
                  <span class="fab fa-github mr-1"></span>
                github
              </a>
              <a class="dropdown-item" href="https://gitlab.com/clokep" target="_blank">
                  <span class="fab fa-gitlab mr-1"></span>
                gitlab
              </a>
              <a class="dropdown-item" href="https://www.linkedin.com/in/patrickcloke/" target="_blank">
                  <span class="fab fa-linkedin mr-1"></span>
                linkedin
              </a>
            </span>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="feeds-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Feeds
            </a>

            <span class="dropdown-menu dropdown-menu-right" aria-labelledby="feeds-dropdown">
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a>
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a>
            </span>
          </li>

          <form class="form-inline" method="get" action="http://www.google.com/search">
            <input class="form-control form-control-sm mr-sm-2" type="search" name="q" placeholder="Search" aria-label="Search" />
            <input type="hidden"  name="sitesearch" value="patrick.cloke.us" />

            <button class="btn btn-sm btn-outline-info d-none d-sm-inline" type="submit">Search</button>
          </form>
        </ul>
      </div>
    </nav>

<div class="container">
  <div class="row">
    <div class="col-md-12 mt-2 mb-2">
      <h1>
        <a href="/posts/2012/11/28/javascript-typed-arrays-pain/" rel="bookmark"
           title="Permalink to JavaScript typed arrays pain">JavaScript typed arrays&nbsp;pain</a>
      </h1>

      <div class="row">
        <div class="col-sm">
          <span class="text-secondary font-weight-light font-italic">Published on Wednesday, November 28, 2012</span>

          <br>
          <span class="text-secondary font-weight-light font-italic">
            Tags:               <a href="/tag/instantbird.html">Instantbird</a>,              <a href="/tag/mozilla.html">Mozilla</a>,              <a href="/tag/oscar.html">OSCAR</a>,              <a href="/tag/thunderbird.html">Thunderbird</a>,              <a href="/tag/wat.html">Wat</a>          </span>
        </div>

        <div class="col-sm text-right">
          <a href="https://twitter.com/intent/tweet?text=JavaScript%20typed%20arrays%C2%A0pain&url=https%3A//patrick.cloke.us/posts/2012/11/28/javascript-typed-arrays-pain/&hashtags=instantbird,mozilla,oscar,thunderbird,wat" target="_blank" class="ml-1 mr-1" title="Share on Twitter">
            <span class="fab fa-twitter"></span>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//patrick.cloke.us/posts/2012/11/28/javascript-typed-arrays-pain/" target="_blank" class="ml-1 mr-1" title="Share on Facebook">
            <span class="fab fa-facebook"></span>
          </a>
          <a href="mailto:?subject=JavaScript%20typed%20arrays%C2%A0pain&amp;body=https%3A//patrick.cloke.us/posts/2012/11/28/javascript-typed-arrays-pain/" target="_blank" class="ml-1 mr-1" title="Share via Email">
            <span class="fas fa-envelope"></span>
          </a>
        </div>
      </div>

      <hr>

      <div>

        <p>If you&#8217;ve ever tried to deal with binary data in JavaScript you know
it isn&#8217;t much fun and you usually resort to using strings lots of
charCodeAt and related functions. <a class="reference external" href="https://developer.mozilla.org/en-US/docs/JavaScript_typed_arrays">Typed arrays</a> are supposed to solve
this though! The typed array <span class="caps">API</span> consists of creating a buffer of bytes
(called an <a class="reference external" href="https://developer.mozilla.org/en-US/docs/JavaScript_typed_arrays/ArrayBuffer">ArrayBuffer</a>) and then manipulating those bytes via
different views (<a class="reference external" href="https://developer.mozilla.org/en-US/docs/JavaScript_typed_arrays/ArrayBufferView">ArrayBufferView</a>s). You can have multiple views of
the same buffer, starting at different offsets, of different lengths and
types&#8230;which is all neat from a technical point of view, but is it
really useful? It is kind of nice working with the views as if they
were normal arrays&nbsp;though.</p>
<p>I&#8217;ve been playing with these ArrayBuffers quite a bit as I&#8217;m working
on an implementation of the <a class="reference external" href="http://en.wikipedia.org/wiki/OSCAR_protocol"><span class="caps">OSCAR</span> protocol</a> (used for <a class="reference external" href="http://en.wikipedia.org/wiki/AOL_Instant_Messenger"><span class="caps">AOL</span> Instant
Messenger</a> and <a class="reference external" href="http://en.wikipedia.org/wiki/ICQ"><span class="caps">ICQ</span></a>) in the chat backend (for Instantbird /
Thunderbird). (As an aside, the <span class="caps">OSCAR</span> protocol Wikipedia page has
surprisingly good documentation of some of the underlying data
structures of the protocol&#8230;) I started by writing some test code
using ArrayBuffers and views, which have been around a while: since
Gecko 2.0 in fact! I quickly ran into some tedious issues with
repetitive code such&nbsp;as:</p>
<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * A TLV (Type, Length and Value) data structure:</span>
<span class="cm"> *  Unsigned Short  type    Describes what the value represents.</span>
<span class="cm"> *  Unsigned Short  length  The length of the data block.</span>
<span class="cm"> *  Bytes           value   The raw payload.</span>
<span class="cm"> *</span>
<span class="cm"> * The overall length of a TlvBlock is length + 4.</span>
<span class="cm"> *</span>
<span class="cm"> * The inputs to this are:</span>
<span class="cm"> *  aType    The type of the TLV Block.</span>
<span class="cm"> *  aValue   An ArrayBuffer containing the data.</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">TlvBlock</span><span class="p">(</span><span class="nx">aType</span><span class="p">,</span> <span class="nx">aValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">aValue</span><span class="p">.</span><span class="nx">byteLength</span> <span class="o">+</span> <span class="mf">4</span><span class="p">);</span>
  <span class="c1">// The first two bytes are unsigned shorts.</span>
  <span class="kd">let</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">2</span><span class="p">);</span>
  <span class="nx">view</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">aType</span><span class="p">;</span>
  <span class="nx">view</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">aValue</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>

  <span class="c1">// The rest just gets the data copied into it.</span>
  <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mf">4</span><span class="p">);</span>
  <span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">aValue</span><span class="p">));</span>

  <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>This actually illustrates two annoying issues I&nbsp;have:</p>
<ol class="arabic simple">
<li>I end up with extra lines of code defining a new view every time I
switch data&nbsp;types.</li>
<li>There&#8217;s no simple way to copy an ArrayBuffer into a part of an
ArrayBuffer. In the above example I create a Uint8Array view of the
target location, a Uint8Array view of the source location and then
set the source to the target. Seems simple once you figure it out,
but it took a while to figure&nbsp;out.</li>
</ol>
<p>(As an aside, some of you might find the following function helpful,
it is essentially a <a class="reference external" href="http://en.cppreference.com/w/cpp/string/byte/memcpy">memcpy</a> for ArrayBuffers&#8230;this isn&#8217;t really
tested heavily at all,&nbsp;however.)</p>
<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * aTarget / aSource are ArrayBuffers</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">copyBytes</span><span class="p">(</span><span class="nx">aTarget</span><span class="p">,</span> <span class="nx">aSource</span><span class="p">,</span> <span class="nx">aTargetOffset</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="nx">aSourceOffset</span> <span class="o">=</span> <span class="mf">0</span><span class="p">,</span> <span class="nx">aLength</span> <span class="o">=</span> <span class="nx">aSource</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// The rest just gets the data copied into it.</span>
  <span class="kd">let</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">aTarget</span><span class="p">,</span> <span class="nx">aTargetOffset</span><span class="p">);</span>
  <span class="nx">view</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">aSource</span><span class="p">,</span> <span class="nx">aSourceOffset</span><span class="p">,</span> <span class="nx">aLength</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p><span class="caps">OK</span>, so typed arrays seem good, but kind of annoying, right?
Wrong&#8230;the <span class="caps">OSCAR</span> protocol is a &#8220;network order&#8221; protocol (aka it is big
endian). At this point you&#8217;re probably thinking &#8220;<span class="caps">OK</span>, so the ArrayBuffer
constructor must take an endianness flag!&#8221; Wrong, it does no such
thing. &#8220;Hmmm&#8230;Well do the ArrayBufferViews take an endianness flag?&#8221;
Nope, wrong again. The only way to specify the endianness of the data is
to use a <a class="reference external" href="https://developer.mozilla.org/en-US/docs/JavaScript_typed_arrays/DataView">DataView</a>, a slightly different interface to the underlying
bytes. It offers an <span class="caps">API</span> to individually set different data elements via
their offset and endianness. (If you&#8217;re too lazy to read the
documentation all the way through, DataView assumes big endian: makes my
life&nbsp;easier!)</p>
<p>For the curious, JavaScript typed arrays use the system endianness,
which in my opinion is pretty much useless (at least if you plan on
sharing data) since you can never guarantee the endianness to be either
big or little endian. (The fun part is that this isn&#8217;t even documented,
I found it on <a class="reference external" href="http://stackoverflow.com/questions/7869752/javascript-typed-arrays-and-endianness">Stack Overflow</a> and&nbsp;verified.)</p>
<p>So, in summary&#8230;if you plan on networking at all with ArrayBuffers,
don&#8217;t use ArrayBufferViews, use DataViews. (Although Uint8Arrays and
Int8Arrays should work&nbsp;fine!)</p>
<p>And to not rant the <em>entire</em> time, working with typed arrays certainly
does beat strings +&nbsp;charCodeAt!</p>

      </div>

<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = '/posts/2012/11/28/javascript-typed-arrays-pain/';
this.page.identifier = 'javascript-typed-arrays-pain';
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://clokep.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </div>
</div>

    <nav class="navbar fixed-bottom navbar-light bg-light border-top border-info">
      <a href="https://getpelican.com/" class="nav-item" target="_blank">Powered by Pelican</a>
      <a href="https://github.com/clokep/clokep.github.io" class="nav-item" target="_blank">
        Source available on GitHub <span class="fab fa-github"></span>
      </a>
    </nav>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  </body>
</html>