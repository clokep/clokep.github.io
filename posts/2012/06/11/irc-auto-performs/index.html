<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Feed configuration. -->
    <link href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Patrick Cloke Atom Feed" />
    <link href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Patrick Cloke RSS Feed" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="/theme/css/styles.css">
    <link rel="stylesheet" href="/theme/css/borland.css">
    <link rel="stylesheet" href="/theme/css/youtube.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <title>IRC Auto-Performs</title>

    <meta property="og:site_name" content="Patrick Cloke" />
<meta property="og:title" content="IRC Auto-Performs" />
<meta property="og:url" content="https://patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" />
<meta property="og:description" content="There have been a few requests to support “auto-performs” (sending commands to the IRC server after connection that the user types into a box or whatever). Personally I find this to be: A fairly awful user experience. Confusing to new users. Unnecessary. I additionally don’t like this idea since …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-06-11T22:25:00-04:00" />
<meta property="article:author" content="Patrick Cloke" />
<meta property="article:tag" content="Instantbird" />
<meta property="article:tag" content="IRC" />
<meta property="article:tag" content="Mozilla" />

    <script async defer data-domain="cloke.us" src="https://plausible.io/js/plausible.js"></script>
  </head>

  <body class="pb-5">
    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light border-bottom border-info">
      <a class="navbar-brand" href="/">
        Patrick Cloke
      </a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <span class="collapse navbar-collapse" id="navbar-items">
        <ul class="navbar-nav ml-auto">

          <li class="nav-item">
            <a class="nav-link" href="/pages/about.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/pages/projects.html">Projects</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="/archives.html">Archives</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/tags.html">Tags</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="social-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Social
            </a>

            <span class="dropdown-menu dropdown-menu-right" aria-labelledby="social-dropdown">
              <a class="dropdown-item" href="https://mastodon.social/@clokep" target="_blank">
                  <span class="fab fa-mastodon mr-1"></span>
                mastodon
              </a>
              <a class="dropdown-item" href="https://www.twitter.com/clokep" target="_blank">
                  <span class="fab fa-twitter mr-1"></span>
                twitter
              </a>
              <a class="dropdown-item" href="https://matrix.to/#/@clokep:matrix.org" target="_blank">
                  <span class="pl-3 mr-2"></span>
                matrix
              </a>
              <a class="dropdown-item" href="https://github.com/clokep" target="_blank">
                  <span class="fab fa-github mr-1"></span>
                github
              </a>
              <a class="dropdown-item" href="https://gitlab.com/clokep" target="_blank">
                  <span class="fab fa-gitlab mr-1"></span>
                gitlab
              </a>
              <a class="dropdown-item" href="https://www.linkedin.com/in/patrickcloke/" target="_blank">
                  <span class="fab fa-linkedin mr-1"></span>
                linkedin
              </a>
            </span>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="feeds-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Feeds
            </a>

            <span class="dropdown-menu dropdown-menu-right" aria-labelledby="feeds-dropdown">
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a>
              <a class="dropdown-item" href="https://patrick.cloke.us/feeds/rss.xml" type="application/rss+xml" rel="alternate">rss feed</a>
            </span>
          </li>

          <form class="form-inline" method="get" action="http://www.google.com/search">
            <input class="form-control form-control-sm mr-sm-2" type="search" name="q" placeholder="Search" aria-label="Search" />
            <input type="hidden"  name="sitesearch" value="patrick.cloke.us" />

            <button class="btn btn-sm btn-outline-info d-none d-sm-inline" type="submit">Search</button>
          </form>
        </ul>
      </div>
    </nav>

<div class="container">
  <div class="row">
    <div class="col-md-12 mt-2 mb-2">
      <h1>
        <a href="/posts/2012/06/11/irc-auto-performs/" rel="bookmark"
           title="Permalink to IRC Auto-Performs"><span class="caps">IRC</span>&nbsp;Auto-Performs</a>
      </h1>

      <div class="row">
        <div class="col-sm">
          <span class="text-secondary font-weight-light font-italic">Published on Monday, June 11, 2012</span>

          <br>
          <span class="text-secondary font-weight-light font-italic">
            Tags:               <a href="/tag/instantbird.html">Instantbird</a>,              <a href="/tag/irc.html">IRC</a>,              <a href="/tag/mozilla.html">Mozilla</a>          </span>
        </div>

        <div class="col-sm text-right">
          <a href="https://twitter.com/intent/tweet?text=IRC%C2%A0Auto-Performs&url=https%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/&hashtags=instantbird,irc,mozilla" target="_blank" class="ml-1 mr-1" title="Share on Twitter">
            <span class="fab fa-twitter"></span>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" class="ml-1 mr-1" title="Share on Facebook">
            <span class="fab fa-facebook"></span>
          </a>
          <a href="mailto:?subject=IRC%C2%A0Auto-Performs&amp;body=https%3A//patrick.cloke.us/posts/2012/06/11/irc-auto-performs/" target="_blank" class="ml-1 mr-1" title="Share via Email">
            <span class="fas fa-envelope"></span>
          </a>
        </div>
      </div>

      <hr>

      <div>
        <div class="border border-info bg-light rounded float-right p-2 ml-2 mb-2">
          <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#design" id="id1">Design</a></li>
<li><a class="reference internal" href="#messages" id="id2">Messages</a></li>
<li><a class="reference internal" href="#handlers" id="id3">Handlers</a></li>
</ul>
</div>
        </div>

        
<p>There have been a <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=742675">few</a> <a class="reference external" href="https://bugzilla.instantbird.org/show_bug.cgi?id=1101">requests</a> to support “auto-performs”
(sending commands to the <span class="caps">IRC</span> server after connection that the user types
into a box or whatever). Personally I find this to be:</p>
<ol class="arabic simple">
<li>A fairly awful user experience.</li>
<li>Confusing to new users.</li>
<li>Unnecessary.</li>
</ol>
<p>I additionally don’t like this idea since it requires us to have
commands for all the common tasks you’d want to do in an auto-perform
(or support sending absolutely raw messages to the server, which we
actually do already in the /quote command). Essentially what I just
described is writing our own scripting language…that seems pointless
(and frankly, I have better things to do). I’m hoping to convince you
with this post (and maybe a series of posts) that auto-performs aren’t
necessary and a trivial restartless extension can replace them.</p>
<div class="section" id="design">
<h2><a class="toc-backref" href="#id1">Design</a></h2>
<p>Part of the desire to <a class="reference external" href="https://patrick.cloke.us/posts/2011/04/30/why-rewrite-irc-protocol-plugin-part-2/">replace the libpurple <span class="caps">IRC</span> protocol plugin</a>
with a new JavaScript one built specifically for Instantbird (which is
also now used in Thunderbird!) was to make the protocol fully
extensible. There are <a class="reference external" href="https://patrick.cloke.us/posts/2011/03/08/so-called-irc-specifications/">many revisions and unofficial extensions to <span class="caps">IRC</span></a>
and we might not necessarily want to support them all (especially if
they only apply to a single network). Allowing all parts of the protocol
implementation to be touched and extended seemed like a great way to
handle this.</p>
<p>Initially I tried to do this by making the <span class="caps">IRC</span> account into an <span class="caps">XPCOM</span>
component (well it is one already, it’s an prplIAccount, but I meant an
<span class="caps">IRC</span> specific one: implementing ircIAccount, if you will). Unfortunately,
this seemed to have a lot of overhead and got complicated extremely
quickly. Anything I’d want to touch from a message handler (wait,
wait…what’s a handler?! I’ll get back to that) would need to have
methods written and exposed to access internal data of the
account…does that sound very extensible to you? Well, it doesn’t to me…</p>
<p>Onto design two! (Well actually my first design…) Lots of JavaScript
objects! The entire protocol is implemented as a set of JavaScript
objects and the handlers directly touch and modify the account’s data
(of course there’s methods for abstraction, etc.). This means that an
extension has absolutely <span class="caps">FULL</span> access to every about an account…this
also means an extension could seriously mess with and cause the protocol
to stop working or do really crazy things, etc. Unfortunately there
isn’t really a way to avoid that. Hopefully people write good code.</p>
</div>
<div class="section" id="messages">
<h2><a class="toc-backref" href="#id2">Messages</a></h2>
<p>I’m going to go into an aside about messages right now, even though it
doesn’t quite seem relevant yet. It will. <span class="caps">IRC</span> has a bunch of
sub-protocols embedded within the <span class="caps">IRC</span> protocol (see the link above about
unofficial extensions). We attempt to parse all the string messages and
make pretty JavaScript objects out of them. I’ve actually identified
five (yes, count that: five) different sub-“protocols” within <span class="caps">IRC</span> that
we deal:</p>
<ol class="arabic simple">
<li><span class="caps">IRC</span> itself (i.e. <a class="reference external" href="http://tools.ietf.org/html/rfc1459"><span class="caps">RFC</span> 1459</a> / <a class="reference external" href="http://tools.ietf.org/html/rfc2812"><span class="caps">RFC</span> 2812</a> / various numeric extensions)</li>
<li><a class="reference external" href="http://www.irchelp.org/irchelp/rfc/ctcpspec.html"><span class="caps">CTCP</span> (the Client-to-Client Protocol)</a>,embedded in <span class="caps">PRIVMSG</span> commands
of <span class="caps">IRC</span></li>
<li><span class="caps">DCC</span> (Direct Client-to-Client), a subprotocol of <span class="caps">CTCP</span></li>
<li><a class="reference external" href="http://tools.ietf.org/html/draft-brocklesby-irc-isupport-03"><span class="caps">ISUPPORT</span></a> (also known as Numeric 005), a method of negotiating
capabilities between a client and server</li>
<li>And finally, handling of <span class="caps">IRC</span> Services (there’s a lot of them and no
specification, but we treat them specially)</li>
</ol>
<p>Briefly what happens when we receive a raw message over the wire, we
create an <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/irc.js#l14">ircMessage object out of it using a variety of regular
expressions</a>. This object has a variety of fields (see the link for
details), including the command, who sent the message and the parameters.</p>
<p>If the message is identified as a <span class="caps">CTCP</span> message, we then morph the
ircMessage into a <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircCTCP.jsm#l44">CTCPMessage</a>, which can be morphed into a
<a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircDCC.jsm#l20">DCCMessage</a>. Additionally, a 005 reply can be parsed into a
<a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircISUPPORT.jsm#l22">isupportMessage</a>. And last, but not least, a received <span class="caps">PRIVMSG</span> can also
be parsed into a <a class="reference external" href="http://hg.instantbird.org/instantbird/file/b8d8b6e60aef/chat/protocols/irc/ircServices.jsm#l19">ServiceMessage</a>. Each of these extends the <span class="caps">IRC</span>
message without destroying information. (Yes, I’m realizing now that my
choice of whether to use capitals is all messed up…)</p>
<p>Well, why do we care…? By preparsing the strings into objects (as
defined by any “specifications” that exist), we keep extensions from
having to parse messages over and over again from strings.</p>
</div>
<div class="section" id="handlers">
<h2><a class="toc-backref" href="#id3">Handlers</a></h2>
<p>A handler is simply what I call the object that contains the methods
to deal with an incoming message. Pretty much, you get to say “Only send
me <span class="caps">ISUPPORT</span> messages!” or “Only send me <span class="caps">CTCP</span> messages!” and voila, you
only get that type of message. Each message type has a field that is
used to choose the method to run (for the <span class="caps">IRC</span> messages, the “command”,
for <span class="caps">CTCP</span> the “<span class="caps">CTCP</span> command”, <span class="caps">ISUPPORT</span> the “parameter”, etc.) This sounds
a lot more complicated than it is, I think a brief <a class="reference external" href="https://bitbucket.org/clokep/irc-extras/src/6f778f17172a/example/bootstrap.js">example</a> is in order:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">ircSimpleExample</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// The name here is really only used in error messages.</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">"IRC Simple Example"</span><span class="p">,</span>
  <span class="c1">// Slightly above the default priority so we run before the main IRC handler.</span>
  <span class="nx">priority</span><span class="o">:</span> <span class="nx">ircHandlers</span><span class="p">.</span><span class="nx">DEFAULT_PRIORITY</span> <span class="o">+</span> <span class="mf">10</span><span class="p">,</span>
  <span class="c1">// Run this for all accounts (note that the 'this' object in this method is</span>
  <span class="c1">// the JavaScript account object.</span>
  <span class="nx">isEnabled</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="kc">true</span><span class="p">,</span>

  <span class="c1">// The commands we want to handle. For each of these, the account object is</span>
  <span class="c1">// bound to 'this' and the single parameter is of the type that you've</span>
  <span class="c1">// registered your handle.</span>
  <span class="nx">commands</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"001"</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// At the 001 response we've successfully connected to the server.</span>
      <span class="c1">// Send an IDENTIFY command to NickServ.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="s2">"PRIVMSG"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"NickServ"</span><span class="p">,</span> <span class="s2">"IDENTIFY &lt;your password&gt;"</span><span class="p">]);</span>

      <span class="c1">// Return false so the default handler still runs.</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Just like that we’ve designed a handler! Whenever the 001 method is
received from the server, this function will run and attempt to identify
with the NickServ (of course this could use a bit more security on it,
but it’s to demonstrate the possibilities). (The sendMessage function
takes the command to send and an array of parameters to send.)</p>
<p>As this is already a long post, I think I’ll cut this off now and
continue this at another time, but I hope I’m beginning to convince you
that allowing direct access to the account and protocol implementation
is a more powerful (and even simpler in many ways, in my opinion)
alternative to “auto-performs”. The one major downside I see to this, is
that it requires a bit more understanding of the actual protocol level
implementation, I don’t feel that knowing you need to use “<span class="caps">PRIVMSG</span>” as a
command instead of /msg is a huge issue, however.</p>
</div>

      </div>

<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = '/posts/2012/06/11/irc-auto-performs/';
this.page.identifier = 'irc-auto-performs';
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://clokep.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </div>
</div>

    <nav class="navbar fixed-bottom navbar-light bg-light border-top border-info">
      <a href="https://getpelican.com/" class="nav-item" target="_blank">Powered by Pelican</a>
      <a href="https://github.com/clokep/clokep.github.io" class="nav-item" target="_blank">
        Source available on GitHub <span class="fab fa-github"></span>
      </a>
    </nav>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  </body>
</html>