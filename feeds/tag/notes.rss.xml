<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"><channel><title>Patrick Cloke - notes</title><link>https://patrick.cloke.us/</link><description></description><lastBuildDate>Fri, 15 Dec 2023 15:41:00 -0500</lastBuildDate><item><title>Matrix Intentional Mentions explained</title><link>https://patrick.cloke.us/posts/2023/12/15/matrix-intentional-mentions-explained/</link><description>&lt;p&gt;Previously I have written about how &lt;a class="reference external" href="https://patrick.cloke.us/posts/2023/05/08/matrix-push-rules-notifications/"&gt;push rules generate notifications&lt;/a&gt; and how
&lt;a class="reference external" href="https://patrick.cloke.us/posts/2023/01/05/matrix-read-receipts-and-notifications/"&gt;read receipts mark notificiations as read&lt;/a&gt; in the Matrix protocol. This article
is about a change that I instigated to improve &lt;em&gt;when&lt;/em&gt; a &amp;#8220;mention&amp;#8221; (or &amp;#8220;ping&amp;#8221;)
notification is created. (This is a &amp;#8220;highlight&amp;#8221; notification in the Matrix&amp;nbsp;specification.)&lt;/p&gt;
&lt;p&gt;This was part of the work I did at Element to reduce &lt;a class="reference external" href="https://github.com/vector-im/element-meta/issues/886"&gt;unintentional pings&lt;/a&gt;. I
preferred thinking of it in the positive &amp;#8212; that we should only generate a mention
on purpose, hence &amp;#8220;intentional&amp;#8221; mentions. &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3952"&gt;&lt;span class="caps"&gt;MSC3952&lt;/span&gt;&lt;/a&gt; details the technical protocol
changes, but this serves as a bit of a higher-level overview (some of this content
is copied from the &lt;span class="caps"&gt;MSC&lt;/span&gt;).&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;This blog post assumes that default push rules are enabled, these can be heavily
modified, disabled, etc. but that is ignored in this&amp;nbsp;post.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="legacy-mentions"&gt;
&lt;h2&gt;Legacy&amp;nbsp;mentions&lt;/h2&gt;
&lt;p&gt;The legacy mention system searches for the current user&amp;#8217;s display name or the
localpart of the Matrix &lt;span class="caps"&gt;ID&lt;/span&gt; &lt;a class="footnote-reference" href="#footnote-1" id="footnote-reference-1"&gt;[1]&lt;/a&gt; in the text content of an event. For example, an
event like the following would generate a mention for&amp;nbsp;me:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// Additional fields ignored.&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;body&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Hello @clokep:matrix.org!&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A &lt;tt class="docutils literal"&gt;body&lt;/tt&gt; content field &lt;a class="footnote-reference" href="#footnote-2" id="footnote-reference-2"&gt;[2]&lt;/a&gt; containing &lt;tt class="docutils literal"&gt;clokep&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;Patrick Cloke&lt;/tt&gt;
would cause a &amp;#8220;highlight&amp;#8221; notification (displayed as red in Element). This isn&amp;#8217;t uncommon
in chat protocols and is how &lt;span class="caps"&gt;IRC&lt;/span&gt; and &lt;span class="caps"&gt;XMPP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Some of the issues with this&amp;nbsp;are:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Replying to a message will re-issue pings from the initial message due to
&lt;a class="reference external" href="https://spec.matrix.org/v1.5/client-server-api/#fallbacks-for-rich-replies"&gt;fallback replies&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Each time a message is edited the new version will be re-evaluated for&amp;nbsp;mentions.&lt;/li&gt;
&lt;li&gt;Mentions occurring &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec/issues/16"&gt;in spoiler contents&lt;/a&gt; or &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec/issues/15"&gt;code blocks&lt;/a&gt; are&amp;nbsp;evaluated.&lt;/li&gt;
&lt;li&gt;If the &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/issues/3011"&gt;localpart of your Matrix &lt;span class="caps"&gt;ID&lt;/span&gt; is a common word&lt;/a&gt; then spurious notifications
might occur (e.g. Travis &lt;span class="caps"&gt;CI&lt;/span&gt; matching if your Matrix &lt;span class="caps"&gt;ID&lt;/span&gt; is &lt;tt class="docutils literal"&gt;&amp;#64;travis:example.org&lt;/tt&gt;).&lt;/li&gt;
&lt;li&gt;If the &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/issues/2735"&gt;localpart or display name of your Matrix &lt;span class="caps"&gt;ID&lt;/span&gt; matches the hostname&lt;/a&gt;
(e.g. &lt;tt class="docutils literal"&gt;&amp;#64;example:example.org&lt;/tt&gt; receives notifications whenever &lt;tt class="docutils literal"&gt;&amp;#64;foo:example.org&lt;/tt&gt;
is replied&amp;nbsp;to).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There were some &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/blob/main/proposals/3952-intentional-mentions.md#prior-proposals"&gt;prior attempts&lt;/a&gt; to fix this, but I would summarize them as attempting
to reduce edge-cases instead of attempting to rethink how mentions are&amp;nbsp;done.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="intentional-mentions"&gt;
&lt;h2&gt;Intentional&amp;nbsp;mentions&lt;/h2&gt;
&lt;p&gt;I chose to call this &amp;#8220;intentional&amp;#8221; mentions since the protocol now requires
explicitly referring to the Matrix IDs to mention in a dedicated field, instead
of implicit references in the text&amp;nbsp;content.&lt;/p&gt;
&lt;p&gt;The overall change is simple: include a list of mentioned users in a new
content field,&amp;nbsp;e.g.:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;// Additional fields ignored.&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;body&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Hello @clokep:matrix.org!&amp;quot;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;m.mentions&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;user_ids&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;@clokep:matrix.org&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Only the &lt;tt class="docutils literal"&gt;m.mentions&lt;/tt&gt; field is used to generate mentions, the &lt;tt class="docutils literal"&gt;body&lt;/tt&gt; field is
no longer involved. Not only does this remove a whole class of potential bugs,
but also allows for &amp;#8220;hidden&amp;#8221; mentions and paves the way for mentions in extensible
events (see &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/4053"&gt;&lt;span class="caps"&gt;MSC4053&lt;/span&gt;&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;That&amp;#8217;s the gist of the change, although the &lt;span class="caps"&gt;MSC&lt;/span&gt; goes deeper into backwards
compatibility, and interacting with replies or&amp;nbsp;edits.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="comparison-to-other-protocols"&gt;
&lt;h2&gt;Comparison to other&amp;nbsp;protocols&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;m.mentions&lt;/tt&gt; field is similar to how &lt;a class="reference external" href="https://developer.twitter.com/en/docs/twitter-api/data-dictionary/object-model/tweet"&gt;Twitter&lt;/a&gt;, &lt;a class="reference external" href="https://docs.joinmastodon.org/entities/Status/#Mention"&gt;Mastodon&lt;/a&gt;, &lt;a class="reference external" href="https://discord.com/developers/docs/resources/channel#message-object"&gt;Discord&lt;/a&gt;,
and &lt;a class="reference external" href="https://learn.microsoft.com/en-us/graph/api/resources/chatmessagemention?view=graph-rest-1.0"&gt;Microsoft Teams&lt;/a&gt; handle mentioning users. The main downside of this approach
is that it is not obvious &lt;em&gt;where&lt;/em&gt; in the text the user&amp;#8217;s mention is (and allows
for hidden&amp;nbsp;mentions).&lt;/p&gt;
&lt;p&gt;The other seriously considered approach was searching for &amp;#8220;pills&amp;#8221; in the &lt;span class="caps"&gt;HTML&lt;/span&gt;
content of the event. This is similar to how &lt;a class="reference external" href="https://api.slack.com/reference/surfaces/formatting#mentioning-users"&gt;Slack&lt;/a&gt; handles mentions, where the
user &lt;span class="caps"&gt;ID&lt;/span&gt; is encoded with some markup &lt;a class="footnote-reference" href="#footnote-3" id="footnote-reference-3"&gt;[3]&lt;/a&gt;. This has a major downside of requiring &lt;span class="caps"&gt;HTML&lt;/span&gt;
parsing on a hotpath of processing notifications (and it is unclear how this would
work for non-&lt;span class="caps"&gt;HTML&lt;/span&gt;&amp;nbsp;clients).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="can-i-use-this"&gt;
&lt;h2&gt;Can I use&amp;nbsp;this?&lt;/h2&gt;
&lt;p&gt;You can! The &lt;span class="caps"&gt;MSC&lt;/span&gt; was approved and &lt;a class="reference external" href="https://spec.matrix.org/v1.9/client-server-api/#user-and-room-mentions"&gt;included in Matrix 1.7&lt;/a&gt;, Synapase has had
support since v1.86.0; it is pretty much up to clients to implement&amp;nbsp;it!&lt;/p&gt;
&lt;p&gt;Element Web has handled (and sent intentional mentions) since v1.11.37, although
I&amp;#8217;m not aware of other clients which do (Element X might now). Hopefully it will
become used throughout the ecosystem since many of the above issues are still
common complaints I see with&amp;nbsp;Matrix.&lt;/p&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-1" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-1"&gt;[1]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;This post ignores room-mentions, but they&amp;#8217;re handled very similarly.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-2" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-2"&gt;[2]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Note that the plaintext content of the event is searched &lt;em&gt;not&lt;/em&gt; the &amp;#8220;formatted&amp;#8221;
content (which is &lt;a class="reference external" href="https://spec.matrix.org/v1.9/client-server-api/#mroommessage-msgtypes"&gt;usually &lt;span class="caps"&gt;HTML&lt;/span&gt;&lt;/a&gt;).&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-3" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-3"&gt;[3]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;This solution should also reduce the number of unintentional mentions, but
doesn&amp;#8217;t allow for hidden mentions.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Patrick Cloke</dc:creator><pubDate>Fri, 15 Dec 2023 15:41:00 -0500</pubDate><guid isPermaLink="false">tag:patrick.cloke.us,2023-12-15:/posts/2023/12/15/matrix-intentional-mentions-explained/</guid><category>articles</category><category>matrix</category><category>notes</category></item><item><title>Matrix Presence</title><link>https://patrick.cloke.us/posts/2023/12/15/matrix-presence/</link><description>&lt;p&gt;I put together some notes on presence when implementing &lt;a class="reference external" href="https://github.com/matrix-org/synapse/pull/16066"&gt;multi-device support for presence&lt;/a&gt;
in Synapse, maybe this is helpful to others! This is a combination of information
from the specification, as well as some information about how Synapse&amp;nbsp;works.&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;These notes are true as of the v1.9 of the Matrix spec and also cover some
Matrix spec changes which may or may not have been merged&amp;nbsp;since.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="presence-in-matrix"&gt;
&lt;h2&gt;Presence in&amp;nbsp;Matrix&lt;/h2&gt;
&lt;p&gt;Matrix includes basic presence support, which is explained decently from &lt;a class="reference external" href="https://spec.matrix.org/v1.7/client-server-api/#presence"&gt;the specification&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Each user has the concept of presence information. This&amp;nbsp;encodes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Whether the user is currently&amp;nbsp;online&lt;/li&gt;
&lt;li&gt;How recently the user was last active (as seen by the&amp;nbsp;server)&lt;/li&gt;
&lt;li&gt;Whether a given client considers the user to be currently&amp;nbsp;idle&lt;/li&gt;
&lt;li&gt;Arbitrary information about the user’s current status (e.g. “in a&amp;nbsp;meeting”).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This information is collated from both per-device (&lt;tt class="docutils literal"&gt;online&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;idle&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;last_active&lt;/tt&gt;)
and per-user (status) data, aggregated by the user’s homeserver and transmitted
as an &lt;tt class="docutils literal"&gt;m.presence&lt;/tt&gt; event. Presence events are sent to interested parties where
users share a room&amp;nbsp;membership.&lt;/p&gt;
&lt;p&gt;User’s presence state is represented by the presence key, which is an enum of
one of the&amp;nbsp;following:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;online&lt;/tt&gt; : The default state when the user is connected to an event&amp;nbsp;stream.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; : The user is not reachable at this time e.g. they are idle. &lt;a class="footnote-reference" href="#footnote-1" id="footnote-reference-1"&gt;[1]&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;offline&lt;/tt&gt; : The user is not connected to an event stream or is explicitly suppressing their profile information from being&amp;nbsp;sent.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3026"&gt;&lt;span class="caps"&gt;MSC3026&lt;/span&gt;&lt;/a&gt; defines a &lt;tt class="docutils literal"&gt;busy&lt;/tt&gt; presence&amp;nbsp;state:&lt;/p&gt;
&lt;blockquote&gt;
the user is online and active but is performing an activity that would prevent
them from giving their full attention to an external solicitation, i.e. the user
is online and active but not available.&lt;/blockquote&gt;
&lt;p&gt;Presence information is returned to clients in the &lt;tt class="docutils literal"&gt;presence&lt;/tt&gt; key of the
&lt;a class="reference external" href="https://spec.matrix.org/v1.7/client-server-api/#_matrixclientv3sync_presence"&gt;sync response&lt;/a&gt; as a &lt;tt class="docutils literal"&gt;m.presence&lt;/tt&gt; &lt;span class="caps"&gt;EDU&lt;/span&gt; which&amp;nbsp;contains:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;currently_active&lt;/tt&gt;: Whether the user is currently active&amp;nbsp;(boolean)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;last_active_ago&lt;/tt&gt;: The last time since this used performed some action, in&amp;nbsp;milliseconds.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;presence&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;online&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;, or &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt; (or &lt;tt class="docutils literal"&gt;busy&lt;/tt&gt;)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;status_msg&lt;/tt&gt;: An optional description to accompany the&amp;nbsp;presence.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="updating-presence"&gt;
&lt;h3&gt;Updating&amp;nbsp;presence&lt;/h3&gt;
&lt;p&gt;Clients can call &lt;a class="reference external" href="https://spec.matrix.org/v1.8/client-server-api/#put_matrixclientv3presenceuseridstatus"&gt;&lt;tt class="docutils literal"&gt;&lt;span class="caps"&gt;PUT&lt;/span&gt; &lt;span class="pre"&gt;/_matrix/client/v3/presence/{userId}/status&lt;/span&gt;&lt;/tt&gt;&lt;/a&gt; to update the presence state &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; status message or
can set the presence state via &lt;a class="reference external" href="https://spec.matrix.org/v1.8/client-server-api/#get_matrixclientv3sync"&gt;the &lt;tt class="docutils literal"&gt;set_presence&lt;/tt&gt; parameter on &lt;tt class="docutils literal"&gt;/sync&lt;/tt&gt; request&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Note that when using the &lt;tt class="docutils literal"&gt;set_presence&lt;/tt&gt; parameter, &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt; is equivalent to
&amp;#8220;do not make a&amp;nbsp;change&amp;#8221;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="user-activity"&gt;
&lt;h3&gt;User&amp;nbsp;activity&lt;/h3&gt;
&lt;p&gt;From the &lt;a class="reference external" href="https://spec.matrix.org/v1.7/client-server-api/#last-active-ago"&gt;Matrix spec on last active ago&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
The server maintains a timestamp of the last time it saw a pro-active event from
the user. A pro-active event may be sending a message to a room or changing presence
state to &lt;tt class="docutils literal"&gt;online&lt;/tt&gt;. This timestamp is presented via a key called &lt;tt class="docutils literal"&gt;last_active_ago&lt;/tt&gt;
which gives the relative number of milliseconds since the pro-active event.&lt;/blockquote&gt;
&lt;p&gt;If the presence is set to &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; then &lt;tt class="docutils literal"&gt;last_active_ago&lt;/tt&gt; is not part of the
&lt;tt class="docutils literal"&gt;/sync&lt;/tt&gt; response and &lt;tt class="docutils literal"&gt;currently_active&lt;/tt&gt; is returned&amp;nbsp;instead.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="idle-timeout"&gt;
&lt;h3&gt;Idle&amp;nbsp;timeout&lt;/h3&gt;
&lt;p&gt;From the &lt;a class="reference external" href="https://spec.matrix.org/v1.7/client-server-api/#idle-timeout"&gt;Matrix spec on automatically idling users&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
The server will automatically set a user’s presence to &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; if their
last active time was over a threshold value (e.g. 5 minutes). Clients can manually
set a user’s presence to &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;. Any activity that bumps the last active
time on any of the user’s clients will cause the server to automatically set their
presence to &lt;tt class="docutils literal"&gt;online&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3026"&gt;&lt;span class="caps"&gt;MSC3026&lt;/span&gt;&lt;/a&gt; also&amp;nbsp;recommends:&lt;/p&gt;
&lt;blockquote&gt;
If a user&amp;#8217;s presence is set to &lt;tt class="docutils literal"&gt;busy&lt;/tt&gt;, it is strongly recommended for implementations
to not implement a timer that would trigger an update to the &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; state
(like most implementations do when the user is in the &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; state).&lt;/blockquote&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="presence-in-synapse"&gt;
&lt;h2&gt;Presence in&amp;nbsp;Synapse&lt;/h2&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p&gt;This describes Synapse&amp;#8217;s behavior &lt;em&gt;after&lt;/em&gt; v1.93.0. Before that version Synapse
did not account for multiple devices, essentially meaning that the latest device
update&amp;nbsp;won.&lt;/p&gt;
&lt;p class="last"&gt;This also only applies to &lt;em&gt;local&lt;/em&gt; users; per-device information for remote users
is not available, only the combined per-user&amp;nbsp;state.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;User&amp;#8217;s devices can set a device&amp;#8217;s presence state and a user&amp;#8217;s status message.
A user&amp;#8217;s device knows better than the server whether they&amp;#8217;re online and should
send that state as part of &lt;tt class="docutils literal"&gt;/sync&lt;/tt&gt; calls (e.g. sending &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;
or &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;Thus a device is only ever able to set the &amp;#8220;minimum&amp;#8221; presence state for the user.
Presence states are coalesced across devices as
&lt;tt class="docutils literal"&gt;busy&lt;/tt&gt; &amp;gt; &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; &amp;gt; &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; &amp;gt; &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt;. You can build simple
truth tables of how these combine with multiple&amp;nbsp;devices:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="33%" /&gt;
&lt;col width="33%" /&gt;
&lt;col width="33%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Device 1&lt;/th&gt;
&lt;th class="head"&gt;Device 2&lt;/th&gt;
&lt;th class="head"&gt;User state&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;&lt;tt class="docutils literal"&gt;online&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;online&lt;/tt&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;tt class="docutils literal"&gt;busy&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;online&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;busy&lt;/tt&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;offline&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Additionally, users expect to see the latest activity time across all devices.
(And therefore if any device is online and the latest activity is recent then
the user is currently&amp;nbsp;active).&lt;/p&gt;
&lt;p&gt;The status message is global and setting it should always override any previous
state (and never be cleared&amp;nbsp;automatically).&lt;/p&gt;
&lt;div class="section" id="automatic-state-transitions"&gt;
&lt;h3&gt;Automatic state&amp;nbsp;transitions&lt;/h3&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;Note that the below only describes the logic for &lt;em&gt;local&lt;/em&gt; users. Data received
over federation is handled&amp;nbsp;differently.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;If a device is &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt; it should transition to &lt;tt class="docutils literal"&gt;online&lt;/tt&gt;
if a &amp;#8220;pro-active event&amp;#8221; occurs. This includes sending a receipt or event, or syncing
without &lt;tt class="docutils literal"&gt;set_presence&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;set_presence=online&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;If a device is &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt; it should transition to &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; if it is syncing
with &lt;tt class="docutils literal"&gt;set_presence=unavailable&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;If a device is &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; (either directly or implicitly via user actions) it should
transition to &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; (idle) after a period of time &lt;a class="footnote-reference" href="#footnote-2" id="footnote-reference-2"&gt;[2]&lt;/a&gt; if the device is
continuing to sync. (Note that this implies the sync is occurring with
&lt;tt class="docutils literal"&gt;set_presence=unavailable&lt;/tt&gt; as otherwise the device is continuing to report as
&lt;tt class="docutils literal"&gt;online&lt;/tt&gt;). &lt;a class="footnote-reference" href="#footnote-3" id="footnote-reference-3"&gt;[3]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;If a device is &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; it should transition to  &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt;
after a period of time if it is not syncing and not making other actions which
would transition the device to &lt;cite&gt;online&lt;/cite&gt;. &lt;a class="footnote-reference" href="#footnote-4" id="footnote-reference-4"&gt;[4]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Note if a device is &lt;tt class="docutils literal"&gt;busy&lt;/tt&gt; it should not transition to other states. &lt;a class="footnote-reference" href="#footnote-5" id="footnote-reference-5"&gt;[5]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;There&amp;#8217;s a &lt;a class="reference external" href="https://github.com/matrix-org/synapse/blob/be65a8ec0195955c15fdb179c9158b187638e39a/tests/handlers/test_presence.py#L971-L1106"&gt;huge testcase&lt;/a&gt; which checks all these&amp;nbsp;transitions.&lt;/p&gt;
&lt;div class="section" id="examples"&gt;
&lt;h4&gt;Examples&lt;/h4&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Two devices continually syncing, one &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; and one &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;. The
end result should be &lt;cite&gt;online&lt;/cite&gt;. &lt;a class="footnote-reference" href="#footnote-6" id="footnote-reference-6"&gt;[6]&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;One device syncing with &lt;tt class="docutils literal"&gt;set_presence=unavailable&lt;/tt&gt; but had a &amp;#8220;pro-active&amp;#8221;
action, after a period of time the user should be &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt; if no additional
&amp;#8220;pro-active&amp;#8221; actions&amp;nbsp;occurred.&lt;/li&gt;
&lt;li&gt;One device that stops syncing (and no other &amp;#8220;pro-active&amp;#8221; actions&amp;#8221; are occurring),
after a period of time the user should be &lt;tt class="docutils literal"&gt;offline&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Two devices continually syncing, one &lt;tt class="docutils literal"&gt;online&lt;/tt&gt; and one &lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;. The
&lt;tt class="docutils literal"&gt;online&lt;/tt&gt; device stops syncing, after a period of time the user should be
&lt;tt class="docutils literal"&gt;unavailable&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-1" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-1"&gt;[1]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;This should be called &lt;tt class="docutils literal"&gt;idle&lt;/tt&gt;.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-2" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-2"&gt;[2]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;The period of time is implementation specific.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-3" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-3"&gt;[3]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Note that syncing with &lt;tt class="docutils literal"&gt;set_presence=offline&lt;/tt&gt; does not transition to offline,
it is equivalent to not syncing. (It is mostly for mobile applications to
process push notifications.)&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-4" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-4"&gt;[4]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;The spec doesn&amp;#8217;t seem to ever say that devices can transition to offline.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-5" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-5"&gt;[5]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;See the &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3026/files#r1287453423"&gt;open thread on the &lt;span class="caps"&gt;MSC3026&lt;/span&gt;&lt;/a&gt;.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-6" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label" /&gt;&lt;col /&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-6"&gt;[6]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;This is essentially the &lt;a class="reference external" href="https://github.com/matrix-org/synapse/issues/16057"&gt;bug illustrated by the change in Element Web&amp;#8217;s behavior&lt;/a&gt;.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Patrick Cloke</dc:creator><pubDate>Fri, 15 Dec 2023 11:24:00 -0500</pubDate><guid isPermaLink="false">tag:patrick.cloke.us,2023-12-15:/posts/2023/12/15/matrix-presence/</guid><category>articles</category><category>matrix</category><category>notes</category></item><item><title>Matrix Push Rules &amp; Notifications</title><link>https://patrick.cloke.us/posts/2023/05/08/matrix-push-rules-notifications/</link><description>&lt;p&gt;In a previous post about &lt;a class="reference external" href="https://patrick.cloke.us/posts/2023/01/05/matrix-read-receipts-and-notifications/"&gt;read receipts &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; notifications in Matrix&lt;/a&gt; I briefly
mentioned that push rules generate notifications, but with little detail. After
completing a rather large project to improve notifications in Matrix I want to
fill in some of those blanks. &lt;a class="footnote-reference" href="#footnote-1" id="footnote-reference-1"&gt;[1]&lt;/a&gt;&lt;/p&gt;
&lt;!-- comment:

Adapted from https://docs.google.com/presentation/d/1odrbD5wMwGz_qUtG5U1pFb7p3sFwLApDaYtyHpdI-Oo/edit --&gt;

&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;These notes are true as of the v1.6 of the Matrix spec and also cover some
Matrix spec changes which may or may not have been merged since.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="push-notifications-in-matrix"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Push notifications in Matrix&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Matrix includes a &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#push-notifications"&gt;push notifications module&lt;/a&gt; which defines when Matrix events
are considered an unread &lt;strong&gt;notification&lt;/strong&gt; or &lt;strong&gt;highlight notification&lt;/strong&gt; &lt;a class="footnote-reference" href="#footnote-2" id="footnote-reference-2"&gt;[2]&lt;/a&gt;
and &lt;em&gt;how&lt;/em&gt; those events are &lt;strong&gt;sent to third-party push notification services&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Push rules&lt;/strong&gt; are a set of &lt;em&gt;ordered&lt;/em&gt; rules which clients upload to the homeserver.
These are shared by all device and are evaluated per event by the homeserver (and
also by clients). &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#predefined-rules"&gt;Default push rules&lt;/a&gt; are defined in the Matrix spec. Push rules
power the unread (and highlight) counts for each room, push notifications, and the
notifications &lt;span class="caps"&gt;API&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Each rule defines &lt;strong&gt;conditions&lt;/strong&gt; which must be met for the rule to match and
&lt;strong&gt;actions&lt;/strong&gt; to take if the rule matches.&lt;/p&gt;
&lt;p&gt;Processing of push rules occur until a rule matches or all rules have been evaluated.&lt;/p&gt;
&lt;div class="section" id="getting-notifications"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Getting notifications&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As some background, clients receive notifications in one of two ways, via polling
&lt;tt class="docutils literal"&gt;/sync&lt;/tt&gt; and/or via push notifications.&lt;/p&gt;
&lt;p&gt;Web-based clients often receive events via polling:&lt;/p&gt;
&lt;blockquote class="text-center"&gt;
&lt;a class="reference external image-reference" href="https://patrick.cloke.us/images/matrix-push-rules-and-notifications/web-push-flow.png"&gt;&lt;img alt="Notification flow for web applications." src="/thumbnails/matrix-push-rules-and-notifications/web-push-flow_medium.png"/&gt;&lt;/a&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#_matrixclientv3sync_unread-notification-counts"&gt;sync response&lt;/a&gt; (both initial and incremental) include the count of unread
notifications and unread highlight notifications per room.&lt;/p&gt;
&lt;p&gt;Mobile applications often &lt;a class="reference external" href="https://spec.matrix.org/v1.6/push-gateway-api/#overview"&gt;receive events via push&lt;/a&gt; &lt;a class="footnote-reference" href="#footnote-3" id="footnote-reference-3"&gt;[3]&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote class="text-center"&gt;
&lt;a class="reference external image-reference" href="https://patrick.cloke.us/images/matrix-push-rules-and-notifications/mobile-push-flow.png"&gt;&lt;img alt="Notification flow for mobile applications." src="/thumbnails/matrix-push-rules-and-notifications/mobile-push-flow_medium.png"/&gt;&lt;/a&gt;
&lt;/blockquote&gt;
&lt;p&gt;Push notifications include the event information (or just the event &lt;span class="caps"&gt;ID&lt;/span&gt;) and
whether the event was a highlight notification. (The event being pushed implies
it increased the notification count.)&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="first admonition-title"&gt;Note&lt;/p&gt;
&lt;p class="last"&gt;The deployment of the push gateway must be paired with the application (the
push keys must be paired). I.e. if you make your own application (or even
your own build of Element iOS / Android) you cannot re-use the deployment at
matrix.org and must have your own deployment.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="getting-events-which-generated-notifications"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;Getting events which generated notifications&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;There’s &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#listing-notifications"&gt;an &lt;span class="caps"&gt;API&lt;/span&gt; to retrieve a list of events&lt;/a&gt; which the user has been notified
about. This powers the “notification panel” on Element Web and is meant to help
users catch-up on missed notifications.&lt;/p&gt;
&lt;p&gt;It is fairly underspecified and the Synapse implementation has limitations:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Highlight notifications are only kept for 30 days&lt;/li&gt;
&lt;li&gt;Non-highlight notifications are only kept for 72 hours&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Additionally it &lt;a class="reference external" href="https://github.com/vector-im/element-web/issues/6874"&gt;works poorly for encrypted rooms&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="push-rules-background"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-4"&gt;Push rules background&lt;/a&gt;&lt;/h2&gt;
&lt;div class="section" id="getting-the-configured-push-rules"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-5"&gt;Getting the configured push rules?&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;There’s a &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#push-rules-api"&gt;set of APIs to fetch or modify push rules&lt;/a&gt;, they let you:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Fetch all push rules&lt;/li&gt;
&lt;li&gt;Create or delete an individual push rule&lt;/li&gt;
&lt;li&gt;Fetch or update an individual push rule’s actions&lt;/li&gt;
&lt;li&gt;Fetch or enable/disable an individual push rule&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;An initial sync includes all of a user’s push rules under the user’s account data.&lt;/p&gt;
&lt;p&gt;Any changes to push rules are included in incremental syncs. &lt;em&gt;Except&lt;/em&gt; for newly
added rules to the specification (this is likely a homeserver bug).&lt;/p&gt;
&lt;p&gt;Note that you cannot use &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#client-config"&gt;the account data APIs&lt;/a&gt; to configure push rules. &lt;a class="footnote-reference" href="#footnote-4" id="footnote-reference-4"&gt;[4]&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-makes-up-a-push-rule"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-6"&gt;What makes up a push rule?&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A push rule is a &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#_matrixclientv3pushrules_pushrule"&gt;&lt;span class="caps"&gt;JSON&lt;/span&gt; object with the following fields&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;rule_id&lt;/tt&gt;: Unique (per-user) &lt;span class="caps"&gt;ID&lt;/span&gt; for the rule.&lt;ul&gt;
&lt;li&gt;The &lt;tt class="docutils literal"&gt;rule_id&lt;/tt&gt; for default rules have a special form (they start with a
dot: &lt;tt class="docutils literal"&gt;.&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;default&lt;/tt&gt;: Whether the rule is part of the predefined set of rules.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;enabled&lt;/tt&gt;: Whether the rule is enabled.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;conditions&lt;/tt&gt;: an array of 0 or more conditions to match.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;actions&lt;/tt&gt;: 0 or more actions to take if the rule matches.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All conditions must match for a push rule to match. If there are no conditions,
then the push rule always matches. Possible conditions include:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Check event properties against patterns or exact values&lt;ul&gt;
&lt;li&gt;Strings can be compared via globbing or exact values.&lt;/li&gt;
&lt;li&gt;The globbing behavior changes if you’re checking the &lt;tt class="docutils literal"&gt;body&lt;/tt&gt; property or not.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Check against the number of room members&lt;ul&gt;
&lt;li&gt;Used to (incorrectly) check if a room is a direct message.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Check if a user can &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#mroompower_levels"&gt;perform an action&lt;/a&gt; via power rules&lt;ul&gt;
&lt;li&gt;The only defined option is whether a user can send @room.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Push rule actions define &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#actions"&gt;what to do once a push rule&lt;/a&gt; matches an event.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;notify&lt;/tt&gt;: increment the notification count and send a push notification. Uses
“tweaks” to optionally:&lt;ul&gt;
&lt;li&gt;Play a sound.&lt;/li&gt;
&lt;li&gt;Create a highlight notification, this causes the highlight count to be
incremented (in addition to the notification count).&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Can be an empty list to do nothing.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are other undefined or no-op actions (&lt;tt class="docutils literal"&gt;dont_notify&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;coalesce&lt;/tt&gt;) which will be
removed in the next version of the spec. &lt;a class="footnote-reference" href="#footnote-5" id="footnote-reference-5"&gt;[5]&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="types-of-push-rules"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-7"&gt;Types of push rules&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Push rules have a type associated with them, these are executed in order:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Override: generic high priority rules&lt;/li&gt;
&lt;li&gt;Content-specific: applies to messages which have a &lt;tt class="docutils literal"&gt;body&lt;/tt&gt; that matches a &lt;tt class="docutils literal"&gt;pattern&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Room-specific: applies to messages of a room&lt;/li&gt;
&lt;li&gt;Sender-specific: applies to messages from a sender&lt;/li&gt;
&lt;li&gt;Underride: generic low priority rules&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The previously discussed shape of push rules is not the full story! There are
special cases which do not accept conditions, but can be mapped to them.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Content-specific: has a &lt;tt class="docutils literal"&gt;pattern&lt;/tt&gt; field which maps to a pattern against the
&lt;tt class="docutils literal"&gt;body&lt;/tt&gt; property.&lt;/li&gt;
&lt;li&gt;Room-specific: the &lt;tt class="docutils literal"&gt;rule_id&lt;/tt&gt; is re-used to match against the room &lt;span class="caps"&gt;ID&lt;/span&gt;.&lt;/li&gt;
&lt;li&gt;Sender-specific: the &lt;tt class="docutils literal"&gt;rule_id&lt;/tt&gt; is re-used to match against the event &lt;tt class="docutils literal"&gt;sender&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="why-do-clients-care-doesnt-the-homeserver-do-this-all-for-me"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-8"&gt;Why do clients care? Doesn’t the homeserver do this all for me?&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Encryption ruins everything! Some of the push rules require the decrypted event
content to be properly processed. The enable this, the default rules declare
&lt;strong&gt;all encrypted events as notifications&lt;/strong&gt;. Clients are expected to
&lt;strong&gt;re-run push rules on the decrypted content&lt;/strong&gt;. &lt;a class="footnote-reference" href="#footnote-6" id="footnote-reference-6"&gt;[6]&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This can result in one of the following: &lt;a class="footnote-reference" href="#footnote-7" id="footnote-reference-7"&gt;[7]&lt;/a&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Increment the highlight count (the decrypted event results in a highlight)&lt;/li&gt;
&lt;li&gt;No change (the decrypted event results in a notification)&lt;/li&gt;
&lt;li&gt;Decrement notification counts (the decrypted event results in no notification)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Due to gappy syncs clients frequently can only make a best estimate of the true
unread / highlight count of events in encrypted rooms.&lt;/p&gt;
&lt;div class="admonition warning"&gt;
&lt;p class="first admonition-title"&gt;Warning&lt;/p&gt;
&lt;p class="last"&gt;Element iOS / Android get encrypted events pushed to them, but do not properly
implement mentions &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; keywords.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="what-happens-by-default"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-9"&gt;What happens by default?&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://spec.matrix.org/v1.6/client-server-api/#predefined-rules"&gt;default rules are in the Matrix spec&lt;/a&gt; and include:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Highlight:&lt;ul&gt;
&lt;li&gt;Tombstones&lt;/li&gt;
&lt;li&gt;Room &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; user mentions&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Do nothing:&lt;ul&gt;
&lt;li&gt;Notice messages&lt;/li&gt;
&lt;li&gt;Other room member events&lt;/li&gt;
&lt;li&gt;Server &lt;span class="caps"&gt;ACL&lt;/span&gt; updates&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Notification:&lt;ul&gt;
&lt;li&gt;Invites to me&lt;/li&gt;
&lt;li&gt;Messages and encrypted events in non-DMs&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Notification with sound:&lt;ul&gt;
&lt;li&gt;Incoming calls&lt;/li&gt;
&lt;li&gt;Messages and encrypted events in DMs&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Default rules can be disabled or have their actions modified on a per-user basis.
Some of the above features are handled by multiple push rules.&lt;/p&gt;
&lt;div class="section" id="other-standard-rules"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-10"&gt;Other “standard” rules&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Element creates custom push rules based on a known form. &lt;a class="footnote-reference" href="#footnote-8" id="footnote-reference-8"&gt;[8]&lt;/a&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Keywords (implemented as a content-specific rule with a pattern)&lt;/li&gt;
&lt;li&gt;Per-room overrides:&lt;ul&gt;
&lt;li&gt;All messages (implemented as a room-specific rule with a notify action)&lt;/li&gt;
&lt;li&gt;Mentions &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; keywords (implemented as a room-specific rule with no actions)&lt;/li&gt;
&lt;li&gt;Mute (implemented as an override rule to match the room &lt;span class="caps"&gt;ID&lt;/span&gt; with no actions)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Matrix also allows defining arbitrary rules (e.g. to change behavior for particular
rooms, senders, message types, etc.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-about-unread-rooms"&gt;
&lt;h3&gt;&lt;a class="toc-backref" href="#toc-entry-11"&gt;What about unread rooms?&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;The unread (“bold”) rooms logic in Element Web is completely custom and outside
of the Matrix specification.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Will the &lt;a class="reference external" href="https://github.com/matrix-org/matrix-react-sdk/blob/d33e416fc75369d3fec1c1f27ef9d5b2ea0b3703/src/shouldHideEvent.ts#L58-L82"&gt;event be shown&lt;/a&gt; ?&lt;/li&gt;
&lt;li&gt;Is it &lt;a class="reference external" href="https://github.com/matrix-org/matrix-react-sdk/blob/d33e416fc75369d3fec1c1f27ef9d5b2ea0b3703/src/Unread.ts#L41-L48"&gt;not an ignored event type&lt;/a&gt; ?&lt;/li&gt;
&lt;li&gt;Is it &lt;a class="reference external" href="https://github.com/matrix-org/matrix-react-sdk/blob/d33e416fc75369d3fec1c1f27ef9d5b2ea0b3703/src/Unread.ts#L52"&gt;not redacted&lt;/a&gt; ?&lt;/li&gt;
&lt;li&gt;Does a &lt;a class="reference external" href="https://github.com/matrix-org/matrix-react-sdk/blob/d33e416fc75369d3fec1c1f27ef9d5b2ea0b3703/src/Unread.ts#L53"&gt;renderer exist for the event&lt;/a&gt; ?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note that if you enable hidden events (or tweak other options to show events)
then the behavior changes!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="putting-it-altogether"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-12"&gt;Putting it altogether…&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;…it gets complicated trying to figure out whether a message will generate a
notification or not.&lt;/p&gt;
&lt;blockquote class="text-center"&gt;
&lt;a class="reference external image-reference" href="https://patrick.cloke.us/images/matrix-push-rules-and-notifications/default-push-rules.png"&gt;&lt;img alt="Flow chart of the default Matrix push rules when using Element." src="/thumbnails/matrix-push-rules-and-notifications/default-push-rules_medium.png"/&gt;&lt;/a&gt;
&lt;p&gt;The default Matrix push rules (also showing the options available within Element).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-1" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-1"&gt;[1]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Improving unintentional mentions (&lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3952"&gt;&lt;span class="caps"&gt;MSC3952&lt;/span&gt;&lt;/a&gt;) is the main feature we were
working on, but this was powered by &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3758"&gt;&lt;span class="caps"&gt;MSC3758&lt;/span&gt;&lt;/a&gt; (from &lt;a class="reference external" href="https://www.beeper.com/"&gt;Beeper&lt;/a&gt;),
&lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3873"&gt;&lt;span class="caps"&gt;MSC3873&lt;/span&gt;&lt;/a&gt; (from a coworker), and &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3966"&gt;&lt;span class="caps"&gt;MSC3966&lt;/span&gt;&lt;/a&gt;. &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3980"&gt;&lt;span class="caps"&gt;MSC3980&lt;/span&gt;&lt;/a&gt; was also a
follow-up for consistency.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-2" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-2"&gt;[2]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;p class="first"&gt;Notification count (the grey badge with count in Element Web) is the number
of unread messages in a room. Highlight count (the red badge with count in
Element Web) is the number of unread mentions in a room.&lt;/p&gt;
&lt;div class="admonition warning"&gt;
&lt;p class="first admonition-title"&gt;Warning&lt;/p&gt;
&lt;p class="last"&gt;The unread (“bold”) rooms feature in Element Web, which represents a room
with unread messages (but no notification count) is not powered by push
rules (and is not specced).&lt;/p&gt;
&lt;/div&gt;
&lt;p class="last"&gt;See the &lt;a class="reference external" href="https://github.com/matrix-org/matrix-react-sdk/blob/develop/docs/room-list-store.md#list-ordering-algorithm-importance"&gt;Element Web docs on the room list&lt;/a&gt;.&lt;/p&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-3" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-3"&gt;[3]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;This post generally defines “push notifications” as a notification which
is sent via a push provider to an application. Push providers include Apple,
Google, Microsoft, or Mozilla.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-4" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-4"&gt;[4]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/4010"&gt;&lt;span class="caps"&gt;MSC4010&lt;/span&gt;&lt;/a&gt; aims to make this explicit.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-5" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-5"&gt;[5]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;See &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec-proposals/pull/3987"&gt;&lt;span class="caps"&gt;MSC3987&lt;/span&gt;&lt;/a&gt;.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-6" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-6"&gt;[6]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;It was not clear how clients should handle encrypted events &lt;a class="reference external" href="https://github.com/matrix-org/matrix-spec/pull/1461"&gt;until recently&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-7" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-7"&gt;[7]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Adapted from a &lt;a class="reference external" href="https://gist.github.com/Half-Shot/f9501916363894761a1659250aa25181"&gt;Gist from Half-Shot&lt;/a&gt;.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;table class="docutils footnote" frame="void" id="footnote-8" rules="none"&gt;
&lt;colgroup&gt;&lt;col class="label"/&gt;&lt;col/&gt;&lt;/colgroup&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td class="label"&gt;&lt;a class="fn-backref" href="#footnote-reference-8"&gt;[8]&lt;/a&gt;&lt;/td&gt;&lt;td&gt;These don’t seem to be specced, I’m unsure if other clients create similar
rules or understand these rules.&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Patrick Cloke</dc:creator><pubDate>Mon, 08 May 2023 14:56:00 -0400</pubDate><guid isPermaLink="false">tag:patrick.cloke.us,2023-05-08:/posts/2023/05/08/matrix-push-rules-notifications/</guid><category>articles</category><category>matrix</category><category>notes</category></item><item><title>Matrix Read Receipts &amp; Notifications</title><link>https://patrick.cloke.us/posts/2023/01/05/matrix-read-receipts-and-notifications/</link><description>&lt;p&gt;I recently wrapped up a project on improving notifications in threads for Matrix.
This is adapted from my &lt;a href="https://hackmd.io/bbucQKOLTv66N4B_wjDLFQ"&gt;research notes&lt;/a&gt;
to understand the status quo before adapting the Matrix protocol for threads
(in &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3771"&gt;&lt;span class="caps"&gt;MSC3771&lt;/span&gt;&lt;/a&gt; and &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3773"&gt;&lt;span class="caps"&gt;MSC3773&lt;/span&gt;&lt;/a&gt;). Hopefully others find the information&amp;nbsp;useful!&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="admonition-title"&gt;Note&lt;/p&gt;
&lt;p&gt;These notes are true as of the v1.3 of the Matrix spec and also cover some
Matrix spec changes which may or may not have been merged since. It is known
to be out of date with the changes from &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2285"&gt;&lt;span class="caps"&gt;MSC2285&lt;/span&gt;&lt;/a&gt;, &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3771"&gt;&lt;span class="caps"&gt;MSC3771&lt;/span&gt;&lt;/a&gt;, and &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3773"&gt;&lt;span class="caps"&gt;MSC3773&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;hr&gt;
&lt;h2&gt;Receipts&lt;/h2&gt;
&lt;p&gt;Matrix uses &amp;#8220;receipts&amp;#8221; to note which part of a room has been read by a user.
It considers the history for a room to be split into three sections&lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Messages the user has read (or indicated they aren’t interested in&amp;nbsp;them).&lt;/li&gt;
&lt;li&gt;Messages the user might have read some but not&amp;nbsp;others.&lt;/li&gt;
&lt;li&gt;Messages the user hasn’t seen&amp;nbsp;yet.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The &lt;strong&gt;fully read marker&lt;/strong&gt; is between 1 &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; 2 while the &lt;strong&gt;read receipt&lt;/strong&gt; is between
2 &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; 3. Note that fully read markers are not shared with other users while read receipts&amp;nbsp;are.&lt;/p&gt;
&lt;p&gt;Another way to consider this is&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Fully read marker&lt;/strong&gt;: a private bookmark to indicate the point which has been
   processed in the discussion. This allows a user to go back to it&amp;nbsp;later.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Read receipts&lt;/strong&gt;: public indicators of what a user has seen to inform other
   participants that the user has seen&amp;nbsp;it.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Hidden read receipts&lt;/strong&gt;: a private mechanism to synchronize &amp;#8220;unread messages&amp;#8221;
   indicators between a user&amp;#8217;s devices (while still retaining the ability from 1
   as a separate concept). (See &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2285"&gt;&lt;span class="caps"&gt;MSC2285&lt;/span&gt;&lt;/a&gt;.)&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;&lt;a href="https://spec.matrix.org/v1.3/client-server-api/#fully-read-markers"&gt;Fully read&amp;nbsp;markers&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;They are stored in the room account data for the user (but modified via a separate &lt;span class="caps"&gt;API&lt;/span&gt;).&lt;/p&gt;
&lt;p&gt;The &lt;span class="caps"&gt;API&lt;/span&gt;&amp;nbsp;is:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;POST /_matrix/client/v3/rooms/{roomId}/read_markers&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The read receipt can optionally be updated at the same&amp;nbsp;time.&lt;/p&gt;
&lt;p&gt;In Element Web your fully read marker is displayed as the green line across the&amp;nbsp;conversation.&lt;/p&gt;
&lt;h3&gt;&lt;a href="https://spec.matrix.org/v1.3/client-server-api/#receipts"&gt;Read&amp;nbsp;receipts&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Only &lt;code&gt;m.read&lt;/code&gt; is defined at the moment, but it is meant to be generic&amp;nbsp;infrastructure.&lt;/p&gt;
&lt;p&gt;Updating a read receipt updates a &amp;#8220;marker&amp;#8221; which causes any notifications prior
to and including the event to be marked as read.&lt;sup id="fnref:3"&gt;&lt;a class="footnote-ref" href="#fn:3"&gt;3&lt;/a&gt;&lt;/sup&gt; A user has a single read receipt
&amp;#8220;marker&amp;#8221; per&amp;nbsp;room.&lt;/p&gt;
&lt;p&gt;Passed to clients as an &lt;code&gt;m.receipt&lt;/code&gt; event under the &lt;code&gt;ephemeral&lt;/code&gt; array for each
room in the &lt;code&gt;/sync&lt;/code&gt; response. The event includes a map of event &lt;span class="caps"&gt;ID&lt;/span&gt; -&amp;gt; receipt type
-&amp;gt; user &lt;span class="caps"&gt;ID&lt;/span&gt; -&amp;gt; data (currently just a timestamp). Note that the event is a delta
from previous events. An&amp;nbsp;example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;content&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;$1435641916114394fHBLK:matrix.org&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;m.read&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;@rikj:jki.re&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;          &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;ts&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1436451550453&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;room_id&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;!jEsUZKDJdhlrceRyVU:example.org&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;m.receipt&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;span class="caps"&gt;API&lt;/span&gt;&amp;nbsp;is:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;POST /_matrix/client/v3/rooms/{roomId}/receipt/{receiptType}/{eventId}&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;In Element Web read receipts are the small avatars on the right hand side of the
conversation. Note that your own read receipt is not&amp;nbsp;shown.&lt;/p&gt;
&lt;h3&gt;&lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2285"&gt;Hidden read receipts (&lt;span class="caps"&gt;MSC2285&lt;/span&gt;)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A new receipt type (&lt;code&gt;m.read.hidden&lt;/code&gt;) to set a read receipt without sharing it with
other users. It also modifies the &lt;code&gt;/read_markers&lt;/code&gt; &lt;span class="caps"&gt;API&lt;/span&gt; to accept the new receipt type
and modifies the &lt;code&gt;/receipts&lt;/code&gt; &lt;span class="caps"&gt;API&lt;/span&gt; to accept the fully read&amp;nbsp;marker.&lt;/p&gt;
&lt;p&gt;This is useful to synchronize notifications across devices while keeping read
status&amp;nbsp;private.&lt;/p&gt;
&lt;h2&gt;&lt;a href="https://spec.matrix.org/v1.2/client-server-api/#push-rules"&gt;Push&amp;nbsp;rules&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A user&amp;#8217;s push rules determine one or more user-specific actions on each event.
They are customizable, but the homeserver provides default rules. They can result
in an action&amp;nbsp;to:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Do&amp;nbsp;nothing&lt;/li&gt;
&lt;li&gt;Notify the user (&lt;code&gt;notify&lt;/code&gt; action), which can have additional actions (&amp;#8220;tweaks&amp;#8221;):&lt;ol&gt;
&lt;li&gt;Highlight the message (&lt;code&gt;highlight&lt;/code&gt; action)&lt;/li&gt;
&lt;li&gt;Play a sound (&lt;code&gt;sound&lt;/code&gt; action)&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;By default, all new &lt;code&gt;m.room.message&lt;/code&gt; and &lt;code&gt;m.room.encrypted&lt;/code&gt; events generate a
notification, events with a user&amp;#8217;s display name or username in them or &lt;code&gt;@room&lt;/code&gt;
generate highlights,&amp;nbsp;etc.&lt;/p&gt;
&lt;h3&gt;&lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/3664"&gt;Push rules for relations (&lt;span class="caps"&gt;MSC3664&lt;/span&gt;)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Augments push rules to allow applying them to the target of an event relationship
and defines a default push rule for replies (not using the reply&amp;nbsp;fallback).&lt;/p&gt;
&lt;h3&gt;&lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2785"&gt;Event notification attributes and actions (&lt;span class="caps"&gt;MSC2785&lt;/span&gt;)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A proposed replacement for push rules, the results are essentially the same
actions (and presumedly would not change the data returned in &lt;code&gt;/sync&lt;/code&gt;, see&amp;nbsp;below).&lt;/p&gt;
&lt;h2&gt;&lt;a href="https://spec.matrix.org/v1.3/client-server-api/#get_matrixclientv3sync"&gt;Notification counts in &lt;code&gt;/sync&lt;/code&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The number of notification events and highlight events since the user&amp;#8217;s last read
receipt are both returned on a per room basis as part of a &lt;code&gt;/sync&lt;/code&gt; response (for
joined&amp;nbsp;room).&lt;/p&gt;
&lt;p&gt;Notification and highlight events are any messages where the push rules resulted
in an action of &lt;code&gt;notify&lt;/code&gt; or &lt;code&gt;highlight&lt;/code&gt;, respectively. (Note that a &lt;code&gt;highlight&lt;/code&gt;
action must be a &lt;code&gt;notify&lt;/code&gt; action, thus &lt;code&gt;highlight_count &amp;lt;= notification_count&lt;/code&gt;.)&lt;/p&gt;
&lt;p&gt;An&amp;nbsp;example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;account_data&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;ephemeral&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;state&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;summary&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;timeline&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;unread_notifications&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;highlight_count&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;notification_count&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;&lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2654"&gt;Unread messages count (&lt;span class="caps"&gt;MSC2654&lt;/span&gt;)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;A new field is added under the &lt;code&gt;unread_notifications&lt;/code&gt; field (&lt;code&gt;unread_count&lt;/code&gt;) which
is the total number of events matching particular criteria since the user&amp;#8217;s last
read&amp;nbsp;receipt.&lt;/p&gt;
&lt;p&gt;This replaces &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2625"&gt;&lt;span class="caps"&gt;MSC2625&lt;/span&gt;&lt;/a&gt;, which adds a new push rule action (&lt;code&gt;mark_unread&lt;/code&gt;) to
perform the same task. In this rendition, &lt;code&gt;notify&lt;/code&gt; implies &lt;code&gt;mark_unread&lt;/code&gt; and thus
&lt;code&gt;highlight_count &amp;lt;= notification_count &amp;lt;= unread_count&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;&lt;a href="https://spec.matrix.org/v1.2/push-gateway-api/#post_matrixpushv1notify"&gt;Push&amp;nbsp;notifications&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Push notifications receive either the number of unread messages (across all rooms)
or the number of rooms with unread messages (depending on the value of
&lt;code&gt;push.group_unread_count_by_room&lt;/code&gt; in the Synapse configuration). Unread messages
are any messages where the push rules resulted in an action of &lt;code&gt;notify&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This information is sent from the homeserver to the push gateway as part of every&amp;nbsp;notification:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;notifications&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;counts&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="nt"&gt;&amp;quot;unread&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="err"&gt;...&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class="footnote"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;From &lt;a href="https://spec.matrix.org/v1.3/client-server-api/#fully-read-markers"&gt;the fully read marker&lt;/a&gt; specification.&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;See &lt;a href="https://github.com/matrix-org/matrix-spec-proposals/pull/2285#discussion_r436383889"&gt;a discussion on &lt;span class="caps"&gt;MSC2285&lt;/span&gt;&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:3"&gt;
&lt;p&gt;&lt;a href="https://spec.matrix.org/v1.3/client-server-api/#receiving-notifications"&gt;Spec on receiving notifications&lt;/a&gt;&amp;#160;&lt;a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Patrick Cloke</dc:creator><pubDate>Thu, 05 Jan 2023 12:15:00 -0500</pubDate><guid isPermaLink="false">tag:patrick.cloke.us,2023-01-05:/posts/2023/01/05/matrix-read-receipts-and-notifications/</guid><category>articles</category><category>matrix</category><category>notes</category></item></channel></rss>